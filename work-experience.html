<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œç¶“æ­· - å±¥æ­·ç³»çµ±</title>
    <link rel="stylesheet" href="./styles/navigation.css">
    <link rel="stylesheet" href="./styles/work-experience-table.css">
    <link rel="stylesheet" href="./styles/work-experience-modal.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        html, body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        @media (max-width: 640px) {
            main {
                padding: 1rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background-color: #fadbd8;
            color: #c0392b;
            padding: 1.5rem;
            border-radius: 4px;
            border-left: 4px solid #e74c3c;
            margin: 2rem 0;
        }

        .error-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        footer {
            background-color: #2c3e50;
            color: #ecf0f1;
            text-align: center;
            padding: 1.5rem;
            font-size: 0.9rem;
            margin-top: auto;
        }

        footer a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s;
        }

        footer a:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- å°è¦½æ¬„ -->
    <nav id="navigation"></nav>

    <!-- ä¸»å…§å®¹å€åŸŸ -->
    <main>
        <div id="work-experience-table"></div>
        <div id="loading" class="loading hidden">
            <span class="loading-spinner"></span>
            <span id="loading-text">æ­£åœ¨è¼‰å…¥å·¥ä½œç¶“æ­·è³‡æ–™...</span>
        </div>
        <div id="error-container"></div>
    </main>

    <!-- æ¨¡æ…‹æ¡†å®¹å™¨ -->
    <div id="modal-container"></div>

    <!-- é è…³ -->
    <footer>
        <p>Â© 2025 å±¥æ­·ç³»çµ±. ç‰ˆæœ¬ 1.0 | æœ€å¾Œæ›´æ–°: <span id="last-updated">2025-11-09</span></p>
        <p><a href="index.html">è¿”å›é¦–é </a> | <a href="portfolio.html">æª¢è¦–ä½œå“é›†</a></p>
    </footer>

    <!-- è¼‰å…¥æ‡‰ç”¨ç¨‹å¼ -->
    <script type="module">
        import { Navigation } from './components/Navigation.js';
        import { WorkExperienceTable } from './components/WorkExperienceTable.js';
        import { WorkExperienceModal } from './components/WorkExperienceModal.js';
        import { WorkExperienceService } from './services/WorkExperienceService.js';
        import { WorkExperienceRepository } from './repositories/WorkExperienceRepository.js';

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        const appState = {
            currentLanguage: 'zh-TW',
            workExperienceData: null,
            sortedRows: [],
            parentExperiences: {}
        };

        /**
         * åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
         */
        async function initializeApp() {
            console.log('ğŸš€ åˆå§‹åŒ–å·¥ä½œç¶“æ­·é é¢...');
            
            try {
                // åˆå§‹åŒ–å°è¦½æ¬„
                Navigation.initialize({
                    containerId: 'navigation',
                    onLanguageChange: handleLanguageChange,
                    onLogout: handleLogout,
                    onMenuClick: handleMenuClick
                });

                // åˆå§‹åŒ–æ¨¡æ…‹æ¡†
                WorkExperienceModal.initialize({
                    containerId: 'modal-container'
                });

                // è¼‰å…¥å·¥ä½œç¶“æ­·è³‡æ–™
                await loadWorkExperienceData(appState.currentLanguage);

                console.log('âœ… æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                showError('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—', error.message);
            }
        }

        /**
         * è¼‰å…¥å·¥ä½œç¶“æ­·è³‡æ–™
         * @param {string} language - èªè¨€ä»£ç¢¼
         */
        async function loadWorkExperienceData(language) {
            showLoading(true);
            
            try {
                // è¼‰å…¥è³‡æ–™
                const data = await WorkExperienceRepository.loadWorkExperienceData(language);
                appState.workExperienceData = data;

                // æº–å‚™è³‡æ–™
                const parentExperiences = await WorkExperienceService.initializeAndSortWorkExperiences(language);
                appState.sortedRows = WorkExperienceService.prepareMainTableRows(parentExperiences);

                // å»ºç«‹ parent è³‡æ–™ç´¢å¼•
                parentExperiences.forEach(exp => {
                    appState.parentExperiences[exp.id] = exp;
                });

                // å–å¾—ç¿»è­¯
                const translations = getTranslations(language);

                // åˆå§‹åŒ–è¡¨æ ¼
                WorkExperienceTable.initialize({
                    containerId: 'work-experience-table',
                    rows: appState.sortedRows,
                    translations,
                    onRowClick: handleTableRowClick
                });

                // æ›´æ–°å°è¦½æ¬„
                Navigation.setCurrentLanguage(language);

                showLoading(false);
                showError(''); // æ¸…é™¤ä»»ä½•éŒ¯èª¤

            } catch (error) {
                showLoading(false);
                showError('è¼‰å…¥å·¥ä½œç¶“æ­·è³‡æ–™å¤±æ•—', error.message);
            }
        }

        /**
         * è™•ç†è¡¨æ ¼è¡Œé»æ“Šäº‹ä»¶
         * @param {Object} clickData - é»æ“Šè³‡æ–™
         */
        function handleTableRowClick(clickData) {
            const { type, id, data } = clickData;

            if (type === 'parent') {
                // é¡¯ç¤º parent è©³æƒ…
                const parentExp = appState.parentExperiences[id];
                if (parentExp) {
                    const childProjects = WorkExperienceService.getParentChildProjects(parentExp);
                    WorkExperienceModal.showParentModal(
                        parentExp,
                        childProjects,
                        handleParentModalChildClick
                    );
                }
            } else if (type === 'child') {
                // ç›´æ¥é¡¯ç¤º child è©³æƒ…
                WorkExperienceModal.showChildModal(data.data);
            }
        }

        /**
         * è™•ç† Parent æ¨¡æ…‹æ¡†ä¸­ Child é …ç›®çš„é»æ“Š
         * @param {Object} projectData - å°ˆæ¡ˆè³‡æ–™
         */
        function handleParentModalChildClick(projectData) {
            // æ­¤åŠŸèƒ½åœ¨æœªä¾†å¯å¯¦ç¾å¤šå±¤æ¨¡æ…‹æ¡†åµŒå¥—
            console.log('Parent æ¨¡æ…‹æ¡†ä¸­çš„ Child è¢«é»æ“Š:', projectData);
        }

        /**
         * è™•ç†èªè¨€åˆ‡æ›
         * @param {string} language - æ–°èªè¨€ä»£ç¢¼
         */
        async function handleLanguageChange(language) {
            console.log(`ğŸŒ èªè¨€åˆ‡æ›ç‚º: ${language}`);
            appState.currentLanguage = language;
            await loadWorkExperienceData(language);
        }

        /**
         * è™•ç†ç™»å‡º
         */
        function handleLogout() {
            console.log('ğŸ”“ ç”¨æˆ¶ç™»å‡º');
            // é€™è£¡å¯ä»¥å¯¦ç¾å¯¦éš›çš„ç™»å‡ºé‚è¼¯
            alert('ç™»å‡ºæˆåŠŸï¼å°‡è¿”å›ç™»å…¥é é¢...');
            window.location.href = 'index.html';
        }

        /**
         * è™•ç†èœå–®é»æ“Š
         * @param {number} index - èœå–®é …ç›®ç´¢å¼•
         * @param {string} menuId - èœå–® ID
         */
        function handleMenuClick(index, menuId) {
            console.log(`ğŸ“Œ èœå–®é …ç›®è¢«é»æ“Š: ${index}`);
            Navigation.setActiveMenuItem(index);
        }

        /**
         * é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
         * @param {boolean} show - æ˜¯å¦é¡¯ç¤º
         */
        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                if (show) {
                    loadingEl.classList.remove('hidden');
                    loadingEl.style.display = 'block';
                } else {
                    loadingEl.classList.add('hidden');
                    loadingEl.style.display = 'none';
                }
            }
        }

        /**
         * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
         * @param {string} title - éŒ¯èª¤æ¨™é¡Œ
         * @param {string} message - éŒ¯èª¤è¨Šæ¯
         */
        function showError(title = '', message = '') {
            const errorContainer = document.getElementById('error-container');
            if (!errorContainer) return;

            if (!title && !message) {
                errorContainer.innerHTML = '';
                return;
            }

            errorContainer.innerHTML = `
                <div class="error">
                    <div class="error-title">âŒ ${title}</div>
                    <div>${message}</div>
                </div>
            `;
        }

        /**
         * å–å¾—ç¿»è­¯æ–‡æœ¬
         * @param {string} language - èªè¨€ä»£ç¢¼
         * @returns {Object} ç¿»è­¯ç‰©ä»¶
         */
        function getTranslations(language) {
            const translations = {
                'zh-TW': {
                    title: 'å·¥ä½œç¶“æ­·',
                    period: 'æœŸé–“',
                    project: 'å°ˆæ¡ˆ/é …ç›®',
                    role: 'è·å‹™/å…§å®¹'
                },
                'ja': {
                    title: 'è·å‹™çµŒæ­´',
                    period: 'æœŸé–“',
                    project: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/é …ç›®',
                    role: 'è·å‹™/å†…å®¹'
                },
                'en': {
                    title: 'Work Experience',
                    period: 'Period',
                    project: 'Project/Item',
                    role: 'Role/Content'
                }
            };

            return translations[language] || translations['zh-TW'];
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
