<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å€‹äººå±¥æ­· - åŠ å¯†å±•ç¤ºç³»çµ±</title>
  <link rel="stylesheet" href="./styles/base.css">
  <link rel="stylesheet" href="./styles/login-screen.css">
  <link rel="stylesheet" href="./styles/navigation.css">
  <link rel="stylesheet" href="./styles/index.css">
</head>

<body>
  <div id="loginScreen"></div>
  <nav id="navigation"></nav>
  <main>
    <div class="header">
      <div>
        <h1>ğŸ‰ æ­¡è¿å›ä¾†</h1>
        <p>è³‡æ–™å·²æˆåŠŸè§£å¯†ä¸¦è¼‰å…¥</p>
      </div>
    </div>
    <div id="contentArea">
      <div class="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
      </div>
    </div>
  </main>

  <script type="module">
    import { LoginComponent } from "./components/LoginComponent.js";
    import { Navigation } from "./components/Navigation.js";
    import { LoginService } from "./services/LoginService.js";
    import { DataRepository } from "./repositories/DataRepository.js";
    import { LanguageManager } from "./i18n/LanguageManager.js";

    let encryptedData = null;
    const contentArea = document.getElementById("contentArea");
    const loginScreen = document.getElementById("loginScreen");
    const mainContent = document.querySelector("main");

    async function init() {
      try {
        // 1. åˆå§‹åŒ–èªè¨€ç®¡ç†å™¨ï¼ˆå„ªå…ˆé †åºï¼šURL > localStorage > é è¨­ï¼‰
        const currentLanguage = LanguageManager.initialize();
        console.log(`ğŸŒ LanguageManager åˆå§‹åŒ–å®Œæˆï¼Œç•¶å‰èªè¨€: ${currentLanguage}`);

        encryptedData = await DataRepository.loadEncryptedData();
        console.log("âœ… åˆå§‹åŒ–å®Œæˆ");

        LoginComponent.initialize({
          containerId: "loginScreen",
          onLogin: handleLogin,
          onCancel: () => console.log("ç™»å…¥å–æ¶ˆ")
        });

        console.log("âœ… LoginComponent åˆå§‹åŒ–å®Œæˆ");

        const menuItems = Navigation.getMenuItemsByLanguage();
        console.log("ğŸ“‹ èœå–®é …ç›®:", menuItems);
        
        Navigation.initialize({
          containerId: "navigation",
          menuItems: menuItems,
          currentLanguage: currentLanguage,
          onLanguageChange: handleLanguageChange,
          onLogout: handleLogout,
          onMenuClick: handleMenuClick,
          translations: menuItems
        });

        console.log("âœ… Navigation åˆå§‹åŒ–å®Œæˆ");

        await tryRestoreSession();
      } catch (error) {
        console.error("âŒ åˆå§‹åŒ–å¤±æ•—:", error);
        LoginComponent.showError("ç„¡æ³•è¼‰å…¥è³‡æ–™æª”æ¡ˆ: " + error.message);
      }
    }

    async function handleLogin(password) {
      try {
        const result = await LoginService.login(password, encryptedData);

        if (result.success) {
          displayContent(result.data);
          loginScreen.style.display = "none";
          mainContent.style.display = "block";
          // ç¢ºä¿å°èˆªæ¬„å¯è¦‹
          const nav = document.getElementById("navigation");
          if (nav) nav.style.display = "block";
          console.log("âœ… ç™»å…¥æˆåŠŸ");
        } else {
          LoginComponent.showError(result.message);
          console.log("âŒ ç™»å…¥å¤±æ•—:", result.message);
        }
      } catch (error) {
        LoginComponent.showError("ç™»å…¥å¤±æ•—: " + error.message);
        console.error("âŒ ç™»å…¥éŒ¯èª¤:", error);
      }
    }

    async function tryRestoreSession() {
      if (!encryptedData) return;

      const result = await LoginService.restoreSession(encryptedData);

      if (result.success) {
        console.log("âœ… æœƒè©±å·²é‚„åŸ");
        displayContent(result.data);
        loginScreen.style.display = "none";
        mainContent.style.display = "block";
        // ç¢ºä¿å°èˆªæ¬„å¯è¦‹
        const nav = document.getElementById("navigation");
        if (nav) nav.style.display = "block";
      }
    }

    function handleLogout() {
      LoginService.logout();
      LoginComponent.reset();
      LoginComponent.focus();
      mainContent.style.display = "none";
      loginScreen.style.display = "flex";
      contentArea.innerHTML = "<div class=\"loading\"><div class=\"spinner\"></div><p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p></div>";
      console.log("âœ… ç™»å‡ºæˆåŠŸ");
    }

    function handleLanguageChange(language) {
      console.log(`ğŸŒ èªè¨€å·²åˆ‡æ›ç‚º: ${language}`);
      Navigation.updateMenuByLanguage(language);
    }

    function handleMenuClick(index, url) {
      console.log(`ğŸ“Œ èœå–®é …ç›®è¢«é»æ“Š: ${index}ï¼ŒURL: ${url}`);
      Navigation.setActiveMenuItem(index);
      if (url) {
        // ä½¿ç”¨ LanguageManager æ·»åŠ èªè¨€åƒæ•¸åˆ° URL
        const urlWithLang = LanguageManager.generateLanguageURL(url);
        window.location.href = urlWithLang;
      }
    }

    function displayContent(data) {
      const html = `
        <div class="content-grid">
          <div class="card full-width">
            <h2>ğŸ‘¤ å€‹äººè³‡è¨Š</h2>
            <div class="card-content">
              <div class="info-item"><strong>å§“åï¼š</strong><span>${data.personal.name}</span></div>
              <div class="info-item"><strong>è·ç¨±ï¼š</strong><span>${data.personal.title}</span></div>
              <div class="info-item"><strong>Emailï¼š</strong><span>${data.personal.email}</span></div>
              <div class="info-item"><strong>é›»è©±ï¼š</strong><span>${data.personal.phone}</span></div>
              <div class="info-item"><strong>åœ°é»ï¼š</strong><span>${data.personal.location}</span></div>
              <div class="info-item"><strong>ç°¡ä»‹ï¼š</strong><span>${data.personal.bio}</span></div>
            </div>
          </div>

          <div class="card">
            <h2>ğŸ’» å°ˆæ¥­æŠ€èƒ½</h2>
            <div class="card-content">
              ${data.skills.map(skill => `
                <div class="skill-category">
                  <h4>${skill.category}</h4>
                  <div class="skill-tags">
                    ${skill.items.map(item => `<span class="skill-tag">${item}</span>`).join("")}
                  </div>
                </div>
              `).join("")}
            </div>
          </div>

          <div class="card">
            <h2>ğŸ“ æ•™è‚²èƒŒæ™¯</h2>
            <div class="card-content">
              ${data.education.map(edu => `
                <div class="experience-item">
                  <h3>${edu.school}</h3>
                  <div class="period">${edu.period}</div>
                  <p>${edu.degree}</p>
                  <p><strong>GPAï¼š</strong> ${edu.gpa}</p>
                </div>
              `).join("")}
            </div>
          </div>

          <div class="card full-width">
            <h2>ğŸ’¼ å·¥ä½œç¶“é©—</h2>
            <div class="card-content">
              ${data.experience.map(exp => `
                <div class="experience-item">
                  <h3>${exp.company} - ${exp.position}</h3>
                  <div class="period">${exp.period}</div>
                  <p>${exp.description}</p>
                  ${exp.achievements ? `<ul class="achievements">${exp.achievements.map(ach => `<li>${ach}</li>`).join("")}</ul>` : ""}
                </div>
              `).join("")}
            </div>
          </div>

          <div class="card full-width">
            <h2>ğŸš€ å°ˆæ¡ˆä½œå“</h2>
            <div class="card-content">
              ${data.projects.map(proj => `
                <div class="project-item">
                  <h3>${proj.name}</h3>
                  <p>${proj.description}</p>
                  <div class="tech"><strong>æŠ€è¡“ï¼š</strong> ${proj.tech.join(", ")}</div>
                  ${proj.url ? `<a href="${proj.url}" target="_blank" style="color: #667eea;">ğŸ”— æŸ¥çœ‹å°ˆæ¡ˆ</a>` : ""}
                </div>
              `).join("")}
            </div>
          </div>

          <div class="card full-width">
            <h2>ğŸ“œ å°ˆæ¥­è­‰ç…§</h2>
            <div class="card-content">
              <div class="skill-tags">
                ${data.certifications.map(cert => `<span class="skill-tag">${cert.name} (${cert.year})</span>`).join("")}
              </div>
            </div>
          </div>
        </div>
      `;
      contentArea.innerHTML = html;
    }

    init();
    console.log("ğŸ” åŠ å¯†å±¥æ­·ç³»çµ±å·²è¼‰å…¥");
    console.log("ğŸ’¡ é è¨­å¯†ç¢¼: mySecurePassword123");
  </script>
</body>

</html>
